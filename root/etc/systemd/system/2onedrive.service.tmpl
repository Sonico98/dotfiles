[Unit]
Description=RClone Service
Wants=network-online.target
After=network-online.target

[Service]
Type=notify
Environment=RCLONE_CONFIG={{ joinPath .nonRootHome ".config/rclone/rclone.conf" }}
KillMode=control-group
RestartSec=5
User={{ .nonRootUser }}
Group={{ .nonRootGroup }}
ExecStart=/usr/bin/rclone mount 2onedrive: /mnt/2onedrive \
# This is for allowing users other than the user running rclone access to the mount
--allow-other \
# Mount it as my user and group
--uid {{ .nonRootUid }} --gid {{ .nonRootGid }} --default-permissions \
# Onedrive is a polling remote so this value can be set very high and any changes are detected via polling.
--dir-cache-time 360m \
# The log level output 
--log-level INFO \
# Location of the log file
--log-file /opt/rclone/logs/rclone2.log \
# I reduce the poll interval down to 15 seconds as this makes changes appear fast the API quotas per day are huge
--poll-interval 15s \
# This is setting the file permission on the mount to user and group have the same access and other can read
--umask 0007 \
# The local disk used for caching
--cache-dir /mnt/Heaven/.rclone_cache2 \
# This is used for caching files to local disk for streaming
--vfs-cache-mode full \
# This limits the cache size to the value below
--vfs-cache-max-size 30G \
# This limits the age in the cache if the size is reached and it removes the oldest files first
--vfs-cache-max-age 168h \
# Waits 10 seconds after a file is closed in cache before uploading
--vfs-write-back 10s \
# This sets the size for each file chunk
--drive-chunk-size 32M \
# Amount of memory to buffer data in advance
--buffer-size 120M \
--vfs-read-ahead 130M \
# This sets a per file bandwidth control and I limit this to a little bigger than my largest bitrate I'd want to play
--bwlimit-file 50M \
# Increases performance by allowing writes to be acknowledged to applications after successful write to cache.
--write-back-cache \
--transfers 6 \
# Enable remote control
--rc \
--rc-addr=localhost:5573

ExecStop=/bin/fusermount -uz /mnt/2onedrive
ExecStartPost=/usr/bin/rclone rc vfs/refresh recursive=true --rc-addr 127.0.0.1:5573 _async=true
Restart=on-failure

[Install]
WantedBy=multi-user.target
